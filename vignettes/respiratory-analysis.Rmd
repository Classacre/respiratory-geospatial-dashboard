---
title: "Pediatric Respiratory Geospatial Analysis"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Pediatric Respiratory Geospatial Analysis}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Introduction

This vignette demonstrates the methodology and analysis workflow for the Pediatric Respiratory Geospatial Dashboard. The dashboard provides tools for analyzing pediatric respiratory health data with geospatial components, focusing on:

1. **Spatial patterns** of asthma prevalence and lung function
2. **Environmental risk factors** including air quality and pollen
3. **Longitudinal trajectories** of lung function development
4. **Risk prediction models** for asthma outcomes

## Data Structure

The synthetic dataset includes 5,000 pediatric patients (ages 2-18) in the Perth metropolitan area with:

- **Demographics**: Age, sex, socioeconomic status
- **Geographic coordinates**: Latitude and longitude
- **Lung function measures**: FEV1, FVC, FEV1/FVC ratio
- **Environmental exposures**: PM2.5, pollen index, temperature
- **Clinical outcomes**: Asthma diagnosis, exacerbations, hospitalizations
- **Longitudinal data**: Multiple visits per patient over time

## Spatial Analysis Methodology

### Spatial Autocorrelation

We use Moran's I statistic to assess spatial clustering of respiratory outcomes:

```{r spatial-analysis, eval=FALSE}
library(respiratorygeospatial)

# Load data
data(respiratory_data)

# Calculate spatial weights
W <- calculate_spatial_weights(respiratory_data, bandwidth = 10)

# Calculate Moran's I for asthma prevalence
asthma_numeric <- as.numeric(respiratory_data$asthma_diagnosis == "Yes")
moran_result <- calculate_morans_i(asthma_numeric, W)

print(moran_result)
```

### Hotspot Detection

Local spatial statistics identify geographic hotspots:

```{r hotspots, eval=FALSE}
# Detect hotspots for exacerbation rates
hotspots <- detect_hotspots(
  respiratory_data,
  outcome_col = "exacerbation_count",
  bandwidth = 5
)

# View hotspot classification
table(hotspots$hotspot_class)
```

## Risk Modeling

### Logistic Regression for Asthma Risk

Environmental and demographic predictors of asthma diagnosis:

```{r risk-model, eval=FALSE}
# Fit logistic model
asthma_model <- fit_asthma_risk_model(
  respiratory_data,
  predictors = c("pm25", "pollen_index", "ses_score", "sex")
)

# Calculate odds ratios
or_table <- calculate_odds_ratios(asthma_model)
print(or_table)
```

### Mixed-Effects Models for Lung Function

Longitudinal lung function trajectories with random effects:

```{r mixed-model, eval=FALSE}
# Fit mixed model for FEV1
fev1_model <- fit_lung_function_model(
  data = respiratory_data,
  outcome = "fev1",
  fixed_effects = c("sex", "pm25", "ics_use"),
  random_effects = c("age_years")
)

summary(fev1_model)
```

## Environmental Exposure Analysis

### PM2.5 and Respiratory Health

```{r pm25-analysis, eval=FALSE}
library(ggplot2)
library(dplyr)

# Compare lung function by PM2.5 quartiles
respiratory_data$pm25_quartile <- cut(
  respiratory_data$pm25,
  breaks = 4,
  labels = c("Q1 (Low)", "Q2", "Q3", "Q4 (High)")
)

pm25_summary <- respiratory_data %>%
  group_by(pm25_quartile) %>%
  summarise(
    mean_fev1 = mean(fev1, na.rm = TRUE),
    sd_fev1 = sd(fev1, na.rm = TRUE),
    n = n()
  )

print(pm25_summary)
```

### Spatial Interpolation

Create continuous surfaces from point measurements:

```{r interpolation, eval=FALSE}
# Create interpolation grid
bbox <- get_perth_bbox()
grid <- create_interpolation_grid(bbox, resolution = 1)

# Interpolate PM2.5 values
pm25_surface <- idw_interpolate(
  respiratory_data,
  value_col = "pm25",
  grid = grid,
  power = 2
)
```

## Dashboard Usage

### Launching the Dashboard

```{r launch, eval=FALSE}
# Launch the Shiny dashboard
run_dashboard()

# Or specify port and other options
run_dashboard(port = 3838, launch.browser = TRUE)
```

### Dashboard Features

1. **Overview Tab**: Summary statistics and demographic distributions
2. **Geospatial Map**: Interactive map with multiple layer options
3. **Lung Function Tab**: Trajectory analysis and growth curves
4. **Risk Prediction Tab**: Model results and performance metrics
5. **Data Explorer Tab**: Interactive data table with download options

## Key Findings

Based on the synthetic data analysis:

1. **Spatial Patterns**: Higher asthma prevalence in areas with elevated PM2.5
2. **Environmental Effects**: Each 1 μg/m³ increase in PM2.5 associated with decreased FEV1
3. **Socioeconomic Gradients**: Lower SES associated with higher exacerbation rates
4. **Sex Differences**: Males show slightly higher lung function values

## References

- Global Initiative for Asthma (GINA) Guidelines
- Perth Air Quality Monitoring Network
- Australian Bureau of Statistics - Socioeconomic Indexes
